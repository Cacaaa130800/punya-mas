<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mood Tracker Mas üíô</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { 
      --bg:#e7f1ff; --text:#1a2a3a; --card:#ffffff; --accent:#6fa8dc; 
      /* Mood Colors for Calendar */
      --mood-senang: #4CAF50; /* Green */
      --mood-biasa: #FFC107; /* Yellow */
      --mood-sedih: #2196F3; /* Blue */
      --mood-kesel: #F44336; /* Red */
      --mood-sayang: #FF69B4; /* Pink */
      --mood-default: #d1d1d1; /* Gray */
      --msg-bg: #ffe4e6; /* Light Pink for Message Card (NEW) */
      --msg-border: #ff85a2; /* Medium Pink (NEW) */
    }
    .dark { 
      --bg:#0f1621; --text:#f1f6ff; --card:#1d2b40; --accent:#4a90e2; 
      --mood-default: #444;
      --msg-bg: #401e21; /* Darker Pink for Message Card */
      --msg-border: #ff85a2;
    }
    *{box-sizing:border-box}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:background .25s, color .25s;
    }
    h1{margin:6px 0 8px 0}
    .controls{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
    .btn{
      padding:8px 12px; border-radius:10px; border:none; cursor:pointer;
      background:var(--accent); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.12)
    }
    .secondary{background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.08)}
    .mood-container{display:flex; gap:14px; margin:18px 0; justify-content:center; flex-wrap:wrap; position: relative;}
    .mood{font-size:38px; cursor:pointer; transition:transform .12s}
    .mood:hover{transform:scale(1.18)}
    .card{
      background:var(--card);
      padding:14px;
      width:92%;
      max-width:560px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(16,24,40,0.06);
      margin-top:14px;
    }
    textarea{width:100%; height:78px; border-radius:10px; padding:10px; border:1px solid #ccc; resize:vertical;
      background:transparent; color:var(--text)}
    #reaction{margin-top:12px; font-size:18px; text-align:center; min-height:36px}
    
    /* CSS UNTUK LOG & TOMBOL HAPUS */
    #entries div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding:8px 0; 
      border-bottom:1px dashed rgba(0,0,0,0.06)
    }
    .delete-btn{
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
      color: #e74c3c;
    }

    /* NEW CSS FOR LEVEL & EXP (MODIFIED) */
    #currentTitle {
        font-size: 1.1em;
        font-weight: 800;
        margin: 0 0 10px 0;
        color: var(--msg-border); /* Use a romantic color for the title */
        text-align: center;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.05);
    }
    .exp-area{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-size:14px}
    #expBar{height:6px;width:100%;background:rgba(0,0,0,0.1);border-radius:3px;margin-top:4px}
    #expFill{height:100%;background:#ffaa7f;border-radius:3px;transition:width .5s ease}
    .exp-text{font-weight:bold;color:#f39c12}
    
    /* NEW CSS FOR DAILY QUEST */
    #questList p { margin: 6px 0; font-size: 15px; }
    
    /* NEW CSS FOR CALENDAR MOOD */
    #moodCalendar{width:100%; margin-top:12px; text-align:center}
    #calendarHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
    #calendarGrid{display:grid; grid-template-columns:repeat(7, 1fr); gap:4px}
    .day-name{font-weight:bold; font-size:12px; padding:4px 0}
    .day-cell{
        width:100%; 
        aspect-ratio: 1 / 1; 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        border-radius:50%; 
        font-size:12px;
        font-weight:bold;
        background:var(--mood-default);
        color:var(--text);
        position:relative;
        transition:background .2s, color .2s;
    }
    .day-cell.mood-set {
        color: white; /* Text white for colored backgrounds */
        cursor: help;
        box-shadow: 0 0 0 2px var(--card) inset; /* Border inside cell */
    }
    .day-cell.today{box-shadow: 0 0 0 3px var(--accent) !important; color:var(--accent)}

    /* NEW CSS FOR DAILY MESSAGE CARD */
    #dailyMessageCard {
        border: 2px solid var(--msg-border) !important;
        background: var(--msg-bg) !important;
        box-shadow: 0 6px 18px rgba(255, 133, 162, 0.2);
    }

    /* NEW CSS FOR SPARKLE EFFECT */
    .loveSparkle{position:absolute;font-size:16px;pointer-events:none;z-index:100;animation:fadeNscale 1.5s ease-out}
    @keyframes fadeNscale{0%{opacity:1;transform:scale(0.8)}100%{opacity:0;transform:scale(1.5)}}
    
    /* STICKER CSS REMOVED */

    .loveHeart{position:fixed; font-size:28px; animation:floatUp 2.4s ease-out; pointer-events:none; z-index:9999}
    @keyframes floatUp{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-160px);opacity:0}}
    #secretModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(3px); align-items:center; justify-content:center; z-index:2000}
    #secretModal .box{background:var(--card); color:var(--text); padding:18px; border-radius:14px; width:88%; max-width:420px; text-align:center}
    @media (max-width:420px){ .mood{font-size:34px} } 
    /* STICKER MEDIA QUERY REMOVED */
  </style>
</head>
<body>
  
  <div id="gate" style="position: fixed; inset: 0; background: var(--bg); color: var(--text); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
    <h1>üîí Hai, Mas! üíô</h1>
    <p style="margin: 0 0 16px 0;">Masukkan kode rahasia atau nama panggilan spesial dari caca untuk membuka.</p>
    <input type="text" id="gateInput" placeholder="Kode atau Nama Spesial" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 300px; margin-bottom: 12px; background: var(--card); color: var(--text);" />
    <button id="gateEnterBtn" class="btn" style="background: var(--accent); color: white;">Masuk ke Tracker</button>
    <p id="gateMsg" style="margin-top: 10px; color: #e74c3c; min-height: 20px;"></p>
  </div>
  <h1>Mood Tracker Mas üíô</h1>

  <div class="controls">
    <button id="themeBtn" class="btn">üåô Mode</button>
    <button id="musicBtn" class="btn">‚ñ∂ Backsound</button>
    <button id="hugBtn" class="btn">ü´Ç Kirim Peluk</button>
    <button id="resetDataBtn" class="btn secondary">‚ö†Ô∏è Reset Semua Data</button> 
    <button id="secretBtn" class="btn secondary">üíå Surat Rahasia</button>
    <button id="downloadBtn" class="btn secondary">‚¨áÔ∏è Download HTML</button>
  </div>
  <p style="margin:6px 0 0 0">Klik mood mas hari ini ‚Äî langsung muncul reaksi manis dari caca:</p>

  <div class="mood-container">
    <span class="mood" data-mood="üòÑ Senang">üòÑ</span>
    <span class="mood" data-mood="üôÇ Biasa aja">üôÇ</span>
    <span class="mood" data-mood="üò¢ Sedih">üò¢</span>
    <span class="mood" data-mood="üò° Kesel">üò°</span>
    <span class="mood" data-mood="ü•∞ Sayang caca">ü•∞</span>
  </div>

  <div id="reaction"></div>
  
  <div class="card" id="dailyMessageCard">
    <h3 style="margin-top: 0; text-align: center;">üíå Pesan Harian dari Caca üíå</h3>
    <p id="dailyMessageContent" style="font-style: italic; text-align: center; margin: 0; font-size: 1.1em;">Belum ada pesan baru hari ini. ü•∫</p>
  </div>
  <div class="card" id="dailyQuestCard">
    <h3>‚ú® Misi Harian Buat Mas</h3>
    <div id="questList" style="list-style-type: none; padding: 0; margin: 0;">
      <em>Memuat misi harian...</em>
    </div>
  </div>
  <div class="card">
    <h3>Catatan Mood & Statistik</h3>
    
    <p id="currentTitle"></p>
    
    <div class="exp-area">
        <span>Poin Cinta: <span id="currentEXP" class="exp-text">0</span></span>
        <span>Streak: <span id="currentStreak" class="exp-text">0</span> Hari</span>
    </div>
    <div id="expBar"><div id="expFill"></div></div>
    <small style="margin-top: 4px; display: block;">*Mendapatkan 10 Poin Cinta setiap hari!</small>
    
    <div id="moodCalendar">
      <div id="calendarHeader">
        <button id="prevMonth" class="btn secondary">&lt;</button>
        <h4 id="monthYear" style="margin:0;"></h4>
        <button id="nextMonth" class="btn secondary">&gt;</button>
      </div>
      <div id="calendarGrid">
        </div>
    </div>
    <div id="monthlySummary" style="margin-top: 15px; margin-bottom: 15px; padding: 10px; background: rgba(111, 168, 220, 0.1); border-radius: 8px;">
      <em>Loading ringkasan mood mas bulan ini...</em>
    </div>
    <canvas id="moodChart" height="140"></canvas>
    <div id="entries" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Catatan Penting dari Mas</h3>
    <textarea id="noteInput" placeholder="Mas mau nulis apa ke caca?"></textarea>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button id="saveNote" class="btn">Simpan Catatan</button>
      <button id="clearNotes" class="btn secondary">Bersihkan Semua</button>
    </div>
    <div id="notes" style="margin-top:12px"></div>
  </div>

  <div class="card" style="cursor:pointer; text-align:center" id="secretPreview">
    <h3>üíô Buka Halaman Rahasia</h3>
    <small>Klik tombol Surat Rahasia atau tombol di atas</small>
  </div>

  <div id="secretModal">
    <div class="box">
      <h2>Pesan Rahasia Buat Mas üíå</h2>
      <p>Mas tuh rumah ternyaman caca... ü©µ<br>makasih udah ada di hidup caca yaaa...</p>
      
      <div style="margin-top: 20px; border-top: 1px solid var(--accent); padding-top: 15px;">
        <h4 style="margin: 0 0 8px 0; color: var(--accent);">Kotak Pesan Harian untuk Mas:</h4>
        <textarea id="dailyMessageInput" placeholder="Tulis pesan manis baru di sini..." style="height: 60px;"></textarea>
        <button id="saveDailyMessageBtn" class="btn" style="margin-top: 8px;">Simpan & Tampilkan Pesan Baru</button>
        <small style="display: block; margin-top: 5px;">*Pesan ini akan tampil di Home Page.</small>
      </div>
      <div style="margin-top:18px">
        <button id="closeSecret" class="btn">Tutup</button>
      </div>
    </div>
  </div>

  <audio id="bgm" loop preload="auto">
    <source src="music.mp3" type="audio/mpeg">
  </audio>

<script>
/* --- Utility & state --- */
// Gate Refs
const gate = document.getElementById('gate');
const gateInput = document.getElementById('gateInput');
const gateEnterBtn = document.getElementById('gateEnterBtn');
const gateMsg = document.getElementById('gateMsg');

// Gate Code
const SECRET_CODE = "sayang"; 
const CODE_NAME = "Mas";    

// App Refs
const moodButtons = document.querySelectorAll('.mood');
const reaction = document.getElementById('reaction');
const entriesBox = document.getElementById('entries');
const notesBox = document.getElementById('notes');
const noteInput = document.getElementById('noteInput');
const bgm = document.getElementById('bgm');
// const sticker = document.getElementById('sticker'); // REMOVED
const secretModal = document.getElementById('secretModal');
let moodChart;
let isDark = false;
let currentCalendarDate = new Date(); 

// Gamification State
let loveEXP = parseInt(localStorage.getItem('loveEXP') || '0');
let lastMoodDate = localStorage.getItem('lastMoodDate') || null;
let currentStreak = parseInt(localStorage.getItem('currentStreak') || '0');
let hugCount = parseInt(localStorage.getItem('hugCount') || '0'); 
const QUESTS_KEY = 'dailyQuests'; 
const DAILY_EXP_REWARD = 20;      
const DAILY_MSG_KEY = 'cacaDailyMessage'; 
const allQuests = [
    { text: "Kirim Pelukan Pertama Hari Ini", action: "hug" },
    { text: "Tulis Minimal 1 Catatan Penting", action: "note" },
    { text: "Catat Mood Lebih dari Sekali", action: "mood_2" },
    { text: "Buka Halaman Rahasia", action: "secret" },
];

/* --- Level System Data (NEW) --- */
const LOVE_LEVELS = [
    { exp: 0, title: "Sayang Junior üê£" },
    { exp: 30, title: "Jagoan Senyum Caca üòä" },
    { exp: 80, title: "Pahlawan Mood ü¶∏" },
    { exp: 150, title: "Sayang Sejati üíç" },
    { exp: 300, title: "Pemilik Hati Caca üëë" },
    { exp: 500, title: "Cinta Abadi ‚ú®" }
];


/* --- Data helpers --- */
function loadLogs(){ return JSON.parse(localStorage.getItem('masMoodLog')||'[]'); }
function saveLogs(logs){ localStorage.setItem('masMoodLog', JSON.stringify(logs)); }
function loadNotes(){ return JSON.parse(localStorage.getItem('masNotes')||'[]'); }
function saveNotes(n){ localStorage.setItem('masNotes', JSON.stringify(n)); }
function loadDailyMessage() { return localStorage.getItem(DAILY_MSG_KEY) || 'Belum ada pesan baru hari ini. ü•∫'; }


/* --- Reactions map & Color Map --- */
const reactions = {
  'üòÑ Senang':'mas seneng?? ya ampun caca ikut senenggg üò≠üíô peluk dulu sini ü´Ç',
  'üôÇ Biasa aja':'mas biasa aja ya hari ini? sini caca temenin biar makin happy ü©µ',
  'üò¢ Sedih':'kok mas sedihhhh üò≠üíô cini ciniiiiii, caca peyukkkkk ü´Çü©µ',
  'üò° Kesel':'siapa yang bikin mas kesel?? ceritain yaaaa, biar caca cubit orang yang nakalin masssss üò§üíô',
  'ü•∞ Sayang caca':'aaaa mas sayang cacaaa?? caca juga sayang mas banyak banyakkkkkkk ü•πü©µüíô'
};

const MOOD_COLOR_MAP = {
    'üòÑ Senang': 'var(--mood-senang)',
    'üôÇ Biasa aja': 'var(--mood-biasa)',
    'üò¢ Sedih': 'var(--mood-sedih)',
    'üò° Kesel': 'var(--mood-kesel)',
    'ü•∞ Sayang caca': 'var(--mood-sayang)',
};


/* --- Gate Logic --- */
function checkGate(code){
    if (code.toLowerCase() === SECRET_CODE || code === CODE_NAME) {
        gate.style.display = 'none';
        gateMsg.textContent = '';
        localStorage.setItem('gateOpened', 'true');
        initApp(); // Jalankan aplikasi setelah gate dibuka
        return true;
    } else {
        gateMsg.textContent = 'Kode salah, Mas! Coba lagi ya.';
        return false;
    }
}

/* --- Gamification: EXP & Level Logic (MODIFIED) --- */
function getLoveTitle(exp) {
    let currentTitle = LOVE_LEVELS[0].title;
    for (const level of LOVE_LEVELS) {
        if (exp >= level.exp) {
            currentTitle = level.title;
        } else {
            break; 
        }
    }
    return currentTitle;
}

function updateEXPDisplay() {
    const title = getLoveTitle(loveEXP);
    document.getElementById('currentTitle').textContent = `Gelar: ${title}`; // NEW
    document.getElementById('currentEXP').textContent = loveEXP;
    document.getElementById('currentStreak').textContent = currentStreak;
    // Progress bar (per 100 EXP)
    const levelMax = 100;
    const progress = (loveEXP % levelMax) / levelMax;
    document.getElementById('expFill').style.width = `${progress * 100}%`;
}

/* --- Daily Message Logic (NEW) --- */
function renderDailyMessage() {
    const message = loadDailyMessage();
    const contentEl = document.getElementById('dailyMessageContent');
    contentEl.innerHTML = message.replace(/\n/g, '<br>');
    
    // Auto-populate input in the modal
    const inputEl = document.getElementById('dailyMessageInput');
    if (inputEl) {
        inputEl.value = (message === 'Belum ada pesan baru hari ini. ü•∫') ? '' : message;
    }
}

function handleSaveDailyMessage() {
    const inputEl = document.getElementById('dailyMessageInput');
    const message = inputEl.value.trim();
    if (message) {
        localStorage.setItem(DAILY_MSG_KEY, message);
        renderDailyMessage();
        reaction.textContent = 'Pesan Harian Caca berhasil diperbarui! üíå';
    } else {
        alert('Pesan tidak boleh kosong!');
    }
}
/* --- END Daily Message Logic --- */


/* --- Hug Logic --- */
function updateHugCount() {
    localStorage.setItem('hugCount', hugCount);
}

function sendHug() {
    const storedQuests = generateQuests();
    const isRewarded = storedQuests.rewarded;

    hugCount += 1;
    updateHugCount();
    
    // Tampilkan efek/pesan pelukan
    const h = document.createElement('div');
    h.className = 'loveHeart'; 
    h.style.fontSize = '40px';
    h.textContent = 'ü´Ç'; 
    h.style.left = '50%'; h.style.bottom = '-10px';
    h.style.transform = 'translateX(-50%)';
    document.body.appendChild(h); 
    setTimeout(() => h.remove(), 2500);

    // Notifikasi
    reaction.textContent = `Pelukan ke-${hugCount} berhasil dikirim ke caca! üíô`;
    
    // Check Quest Completion
    if (!isRewarded) {
        checkQuestCompletion('hug');
    }
}

/* --- Daily Quest Logic --- */
function generateQuests() {
    const today = new Date().toDateString();
    let storedQuests = JSON.parse(localStorage.getItem(QUESTS_KEY));

    if (!storedQuests || storedQuests.date !== today) {
        // Jika hari baru atau tidak ada data, generate 3 misi baru
        const shuffled = allQuests.sort(() => 0.5 - Math.random());
        const newQuests = shuffled.slice(0, 3).map(q => ({
            ...q,
            completed: false
        }));
        storedQuests = { date: today, list: newQuests, rewarded: false };
        localStorage.setItem(QUESTS_KEY, JSON.stringify(storedQuests));
    }
    return storedQuests;
}

// MODIFIED: Added Strikethrough logic
function renderQuests() {
    const storedQuests = generateQuests();
    const quests = storedQuests.list;
    const listEl = document.getElementById('questList');
    listEl.innerHTML = '';
    
    if (storedQuests.rewarded) {
        listEl.innerHTML = '<p style="font-weight: bold; color: var(--accent);">üéâ Semua Misi Hari Ini Selesai! Mas sudah dapat hadiah EXP! üéâ</p>';
        return;
    }

    if(quests.length === 0) {
        listEl.innerHTML = '<em>Tidak ada misi hari ini.</em>';
        return;
    }

    quests.forEach((q, index) => {
        const item = document.createElement('p');
        const status = q.completed ? '‚úÖ' : '‚¨ú';
        item.innerHTML = `${status} ${q.text}`;
        item.style.margin = '4px 0';
        
        if (q.completed) {
            item.style.opacity = '0.6';
            item.style.textDecoration = 'line-through'; 
        } else {
            item.style.opacity = '1';
            item.style.textDecoration = 'none';
        }
        
        listEl.appendChild(item);
    });
}

function checkQuestCompletion(actionType, value = null) {
    let storedQuests = generateQuests();
    let changed = false;

    if (storedQuests.rewarded) return; 

    storedQuests.list.forEach(q => {
        if (q.completed) return;

        if (q.action === actionType) {
            // Specific checks for mood_2
            if (q.action === 'mood_2') {
                const logs = loadLogs();
                const todayLogs = logs.filter(l => new Date(l.date).toDateString() === new Date().toDateString());
                if (todayLogs.length >= 2) { // Use real log count
                    q.completed = true;
                    changed = true;
                }
            } else {
                q.completed = true;
                changed = true;
            }
        }
    });

    if (changed) {
        localStorage.setItem(QUESTS_KEY, JSON.stringify(storedQuests));
        
        const allCompleted = storedQuests.list.every(q => q.completed);
        if (allCompleted) {
            loveEXP += DAILY_EXP_REWARD;
            localStorage.setItem('loveEXP', loveEXP);
            storedQuests.rewarded = true; 
            localStorage.setItem(QUESTS_KEY, JSON.stringify(storedQuests));

            updateEXPDisplay();
            renderQuests(); 
            reaction.textContent = `SEMUA MISI HARIAN SELESAI! üéâ Mas dapat ${DAILY_EXP_REWARD} Poin Cinta Tambahan!`;
        } else {
            renderQuests(); 
        }
    }
}
/* --- END Daily Quest Logic --- */

/* --- NEW FEATURE: MOOD CALENDAR LOGIC --- */
function getMoodsByDate() {
    const logs = loadLogs();
    const moods = {};
    // Hanya ambil log pertama (mood dominan) per hari
    logs.forEach(l => {
        const dateKey = new Date(l.date).toDateString();
        if (!moods[dateKey]) {
            moods[dateKey] = l.mood;
        }
    });
    return moods;
}

function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const todayDateString = new Date().toDateString();
    const moods = getMoodsByDate();
    
    document.getElementById('monthYear').textContent = date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    const daysOfWeek = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
    daysOfWeek.forEach(day => {
        const d = document.createElement('div');
        d.className = 'day-name';
        d.textContent = day;
        grid.appendChild(d);
    });

    const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 6 for Saturday
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Fill initial empty cells
    for (let i = 0; i < firstDayOfMonth; i++) {
        grid.appendChild(document.createElement('div'));
    }

    // Fill days
    for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = new Date(year, month, day).toDateString();
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.textContent = day;

        const mood = moods[dateKey];
        if (mood) {
            const moodColor = MOOD_COLOR_MAP[mood] || 'var(--mood-default)';
            cell.style.backgroundColor = moodColor;
            cell.classList.add('mood-set');
            cell.title = `Mood: ${mood} (Catatan Pertama)`;
        }

        // Highlight today
        if (dateKey === todayDateString) {
            cell.classList.add('today');
        }

        grid.appendChild(cell);
    }
}

function updateCalendarMonth(change) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + change);
    renderCalendar(currentCalendarDate);
}
/* --- END MOOD CALENDAR LOGIC --- */


/* --- Mood click handler (WITH DAILY EXP) --- */
moodButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const today = new Date().toDateString();
    let expGained = false;

    // Logic EXP & STREAK
    if (lastMoodDate !== today) {
        const oldTitle = getLoveTitle(loveEXP); // Capture title before EXP gain
        loveEXP += 10; // Tambah 10 EXP per hari
        if (lastMoodDate) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastMoodDate === yesterday.toDateString()) {
                currentStreak += 1;
            } else {
                currentStreak = 1; // Reset jika terlewat
            }
        } else {
            currentStreak = 1; // First log, start streak
        }
        localStorage.setItem('loveEXP', loveEXP);
        localStorage.setItem('lastMoodDate', today);
        localStorage.setItem('currentStreak', currentStreak);
        updateEXPDisplay();
        expGained = true;
        
        const newTitle = getLoveTitle(loveEXP);
        if (newTitle !== oldTitle) {
            reaction.textContent = `LEVEL UP! Mas naik ke Gelar: ${newTitle}! üèÜ`;
            // Bypass default reaction for level up notification
            return;
        }
    }

    const mood = btn.dataset.mood;
    const date = new Date().toLocaleString();
    const entry = { mood, date };
    const logs = loadLogs();
    
    // Hapus log hari ini agar log pertama menjadi yang dominan
    const cleanedLogs = logs.filter(l => new Date(l.date).toDateString() !== today);
    
    cleanedLogs.unshift(entry);
    saveLogs(cleanedLogs);
    renderLogs();
    
    // Pengecekan Quest Mood ke-2
    checkQuestCompletion('mood_2');

    let reactionText = reactions[mood] || '';
    if (expGained) {
        reactionText += ` (+10 Poin Cinta! üíñ)`;
    }
    reaction.textContent = reactionText;

    spawnTinyHearts();
    if(mood.includes('Sayang')) spawnBigHearts();
    // showSticker(); // STICKER FUNCTION CALL REMOVED
    updateChart();
    renderMonthlySummary(); 
    renderCalendar(currentCalendarDate);
  });
});

/* --- Delete Log handler --- */
window.deleteLog = function(index){
  const logs = loadLogs();
  if(confirm(`Yakin ingin menghapus log mood: ${logs[index].mood} pada ${logs[index].date}?`)){
    logs.splice(index, 1);
    saveLogs(logs);
    renderLogs();
    updateChart();
    renderMonthlySummary();
    renderCalendar(currentCalendarDate);
    // Rerun mood_2 check to see if completion state changes
    checkQuestCompletion('mood_2'); 
  }
}

/* --- Render logs & notes --- */
function renderLogs(){
  const logs = loadLogs();
  entriesBox.innerHTML = '';
  if(logs.length===0) entriesBox.innerHTML = '<em>Belum ada mood tercatat.</em>';
  
  logs.forEach((l, index)=>{ 
    const d = document.createElement('div');
    d.innerHTML = `<span>${l.date} ‚Äî ${l.mood}</span>
      <span class="delete-btn" onclick="deleteLog(${index})">üóëÔ∏è Hapus</span>`;
    entriesBox.appendChild(d);
  });
}
function renderNotes(){
  const notes = loadNotes();
  notesBox.innerHTML = '';
  if(notes.length===0) notesBox.innerHTML = '<em>Belum ada catatan.</em>';
  notes.forEach(n=>{
    const d = document.createElement('div');
    d.textContent = `${n.time} ‚Äî ${n.text}`;
    notesBox.appendChild(d);
  });
}

/* --- Visual Effect & Animations --- */
function startSparkles(el) {
    el.addEventListener('mousemove', function(e) {
        if (Math.random() < 0.2) { 
            const sparkle = document.createElement('div');
            sparkle.className = 'loveSparkle';
            sparkle.textContent = '‚ú®'; 
            const rect = el.getBoundingClientRect();
            sparkle.style.left = (e.clientX - rect.left) + 'px';
            sparkle.style.top = (e.clientY - rect.top) + 'px';
            sparkle.style.position = 'absolute';

            el.appendChild(sparkle);
            setTimeout(() => sparkle.remove(), 1500);
        }
    });
}
// showSticker() function removed

function spawnTinyHearts(){
  for(let i=0;i<6;i++){
    const h = document.createElement('div'); h.className='loveHeart'; h.textContent='üíô';
    h.style.left = Math.random()*92 + 'vw'; h.style.bottom = '-10px';
    document.body.appendChild(h); setTimeout(()=>h.remove(), 2500);
  }
}
function spawnBigHearts(){
  for(let i=0;i<12;i++){
    const h = document.createElement('div'); h.className='loveHeart';
    h.style.fontSize = 34 + Math.floor(Math.random()*18) + 'px'; h.textContent = 'üíñ';
    h.style.left = (40 + Math.random()*20) + 'vw'; h.style.bottom = '-10px';
    document.body.appendChild(h); setTimeout(()=>h.remove(), 2600);
  }
}

/* --- Chart Update --- */
function updateChart(){
  const logs = loadLogs();
  const moodNames = ['üòÑ Senang','üôÇ Biasa aja','üò¢ Sedih','üò° Kesel','ü•∞ Sayang caca'];
  const counts = moodNames.map(m => logs.filter(l => l.mood===m).length);
  const ctx = document.getElementById('moodChart').getContext('2d');
  if(moodChart) moodChart.destroy();
  moodChart = new Chart(ctx, {
    type:'bar',
    data: { labels: moodNames, datasets: [{ label:'Jumlah', data: counts, backgroundColor: ['#66c2ff','#99d6ff','#aab6ff','#c0c0ff','#ffb6c1'] }] },
    options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{precision:0} } } }
  });
}

/* --- Monthly Summary --- */
function renderMonthlySummary(){
  const logs = loadLogs();
  const summaryBox = document.getElementById('monthlySummary');
  
  if (logs.length === 0) {
    summaryBox.innerHTML = '<em>Catatan mood masih kosong. Yuk, mulai hari ini!</em>';
    return;
  }
  
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  const currentMonthLogs = logs.filter(l => {
    const logDate = new Date(l.date);
    return logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear;
  });
  
  if (currentMonthLogs.length === 0) {
    summaryBox.innerHTML = '<em>Belum ada catatan mood di bulan ini.</em>';
    return;
  }
  
  const moodCounts = {};
  currentMonthLogs.forEach(l => {
    const moodKey = l.mood.split(' ')[0]; 
    moodCounts[moodKey] = (moodCounts[moodKey] || 0) + 1;
  });
  
  let dominantMoodText = '';
  let maxCount = 0;
  let totalCount = currentMonthLogs.length;

  for (const moodKey in moodCounts) {
    if (moodCounts[moodKey] > maxCount) {
      maxCount = moodCounts[moodKey];
      for (const fullMood in reactions) {
        if (fullMood.startsWith(moodKey)) {
          dominantMoodText = fullMood;
          break;
        }
      }
    }
  }

  const percentage = ((maxCount / totalCount) * 100).toFixed(0);

  let message = `Mood Mas di bulan ini (${now.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}) didominasi oleh **${dominantMoodText}** (${percentage}% dari total ${totalCount} catatan). `;
  
  if (dominantMoodText.includes('Senang') || dominantMoodText.includes('Sayang')) {
    message += `Pertahankan mood baik ini, mas sayang! caca ikut bahagia! ü•≥üíô`;
  } else if (dominantMoodText.includes('Sedih') || dominantMoodText.includes('Kesel')) {
    message += `Yuk, coba lebih banyak tersenyum! caca selalu di sini untuk menemani Mas. ü§ó`;
  } else {
    message += `Semoga hari-hari berikutnya makin berwarna dan happy ya, Mas!`;
  }
  
  summaryBox.innerHTML = `<p style="font-weight: bold; margin: 0">${message}</p>`;
}


/* --- Event Listeners lainnya --- */

// MODIFIED: Save Note Listener
document.getElementById('saveNote').addEventListener('click', ()=>{
  const text = noteInput.value.trim();
  if(!text) return;
  const notes = loadNotes();
  notes.unshift({ text, time: new Date().toLocaleString() });
  saveNotes(notes);
  noteInput.value='';
  renderNotes();
  checkQuestCompletion('note');
});

// NEW: Save Daily Message Listener
document.addEventListener('DOMContentLoaded', () => {
    const saveDailyMessageBtn = document.getElementById('saveDailyMessageBtn');
    if (saveDailyMessageBtn) {
        saveDailyMessageBtn.addEventListener('click', handleSaveDailyMessage);
    }
});


document.getElementById('clearNotes').addEventListener('click', ()=>{
  if(confirm('Bersihkan semua catatan?')){ localStorage.removeItem('masNotes'); renderNotes(); }
});
noteInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ document.getElementById('saveNote').click(); e.preventDefault(); }});

// MODIFIED: Secret Button Listener
document.getElementById('secretBtn').addEventListener('click', ()=>{ 
    secretModal.style.display='flex'; 
    checkQuestCompletion('secret');
    renderDailyMessage(); // Ensures the input box is updated
});
document.getElementById('closeSecret').addEventListener('click', ()=>{ secretModal.style.display='none'; });
document.getElementById('secretPreview').addEventListener('click', ()=>{ 
    secretModal.style.display='flex'; 
    checkQuestCompletion('secret');
    renderDailyMessage(); // Ensures the input box is updated
});

// HUG BUTTON LISTENER
document.getElementById('hugBtn').addEventListener('click', sendHug); 

// NEW: Calendar Controls Listener
document.getElementById('prevMonth').addEventListener('click', () => updateCalendarMonth(-1));
document.getElementById('nextMonth').addEventListener('click', () => updateCalendarMonth(1));


document.getElementById('musicBtn').addEventListener('click', ()=>{
  if(bgm.paused){ bgm.play(); document.getElementById('musicBtn').textContent='‚è∏ Backsound'; }
  else { bgm.pause(); document.getElementById('musicBtn').textContent='‚ñ∂ Backsound'; }
});
bgm.addEventListener('play', ()=>{ document.getElementById('musicBtn').textContent='‚è∏ Backsound'; });
bgm.addEventListener('pause', ()=>{ document.getElementById('musicBtn').textContent='‚ñ∂ Backsound'; });

document.getElementById('themeBtn').addEventListener('click', ()=>{
  document.body.classList.toggle('dark'); isDark = document.body.classList.contains('dark');
  document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è Mode' : 'üåô Mode';
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'mood_tracker_mas.html';
  document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});

/* --- FINAL FIX: Reset Data Handler (MODIFIED) --- */
document.getElementById('resetDataBtn').addEventListener('click', ()=>{
  if(confirm('Yakin ingin menghapus SEMUA data mood, catatan, EXP, Level, dan Streak? Ini tidak bisa dikembalikan!')){
    // Data Aplikasi Utama
    localStorage.removeItem('masMoodLog');
    localStorage.removeItem('masNotes');
    // NOTE: Keep 'gateOpened' for a moment so the app can load the fresh state
    
    // KUNCI: DATA GAMIFIKASI, QUEST, & MESSAGE
    localStorage.removeItem('loveEXP');
    localStorage.removeItem('lastMoodDate');
    localStorage.removeItem('currentStreak');
    localStorage.removeItem(QUESTS_KEY); 
    localStorage.removeItem('hugCount'); 
    localStorage.removeItem(DAILY_MSG_KEY); // NEW: Hapus pesan harian

    // Now, force reload to apply clean state
    alert('Data berhasil di-reset! Silakan muat ulang halaman.');
    window.location.reload();
  }
});


/* --- Fungsi Utama Aplikasi --- */
function initApp() {
    renderLogs(); 
    renderNotes(); 
    updateChart(); 
    renderMonthlySummary();
    updateEXPDisplay(); 
    renderQuests(); 
    updateHugCount(); 
    renderCalendar(currentCalendarDate); 
    renderDailyMessage(); // NEW: Render pesan harian
    
    // Terapkan efek sparkle
    startSparkles(document.querySelector('.mood-container'));
    startSparkles(document.getElementById('secretPreview'));
}


/* --- Init: Pengecekan Gate --- */
gateEnterBtn.addEventListener('click', () => {
    checkGate(gateInput.value.trim());
});

gateInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        checkGate(gateInput.value.trim());
    }
});

// Jalankan initApp segera jika gate sudah pernah dibuka
if (localStorage.getItem('gateOpened') === 'true') {
    gate.style.display = 'none';
    initApp();
}
</script>
</body>
</html>
