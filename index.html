<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mood Tracker Mas üíô</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { 
      --bg:#e7f1ff; --text:#1a2a3a; --card:#ffffff; --accent:#6fa8dc; 
      /* Mood Colors for Calendar */
      --mood-senang: #4CAF50; /* Green */
      --mood-biasa: #FFC107; /* Yellow */
      --mood-sedih: #2196F3; /* Blue */
      --mood-kesel: #F44336; /* Red */
      --mood-sayang: #FF69B4; /* Pink */
      --mood-default: #d1d1d1; /* Gray */
      --msg-bg: #ffe4e6; /* Light Pink for Message Card (NEW) */
      --msg-border: #ff85a2; /* Medium Pink (NEW) */
    }
    .dark { 
      --bg:#0f1621; --text:#f1f6ff; --card:#1d2b40; --accent:#4a90e2; 
      --mood-default: #444;
      --msg-bg: #401e21; /* Darker Pink for Message Card */
      --msg-border: #ff85a2;
    }
    *{box-sizing:border-box}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:background .25s, color .25s;
    }
    h1{margin:6px 0 8px 0}
    .controls{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
    .btn{
      padding:8px 12px; border-radius:10px; border:none; cursor:pointer;
      background:var(--accent); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.12)
    }
    .secondary{background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.08)}
    .mood-container{display:flex; gap:14px; margin:18px 0; justify-content:center; flex-wrap:wrap; position: relative;}
    .mood{font-size:38px; cursor:pointer; transition:transform .12s}
    .mood:hover{transform:scale(1.18)}
    .card{
      background:var(--card);
      padding:14px;
      width:92%;
      max-width:560px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(16,24,40,0.06);
      margin-top:14px;
    }
    textarea{width:100%; height:78px; border-radius:10px; padding:10px; border:1px solid #ccc; resize:vertical;
      background:transparent; color:var(--text)}
    #reaction{margin-top:12px; font-size:18px; text-align:center; min-height:36px}
    
    /* CSS UNTUK LOG & TOMBOL HAPUS */
    #entries > div {
        /* This is the container for the log entry and its reason */
        border-bottom: 1px dashed rgba(0,0,0,0.06);
        padding: 8px 0;
        margin-bottom: 0;
    }
    #entries .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* NEW CSS FOR NOTE ENTRIES */
    #notes > div {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 8px 0;
        border-bottom: 1px dashed rgba(0,0,0,0.06);
    }
    .delete-btn{
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
      color: #e74c3c;
      flex-shrink: 0;
    }

    /* NEW CSS FOR LEVEL & EXP */
    #currentTitle {
        font-size: 1.1em;
        font-weight: 800;
        margin: 0 0 10px 0;
        color: var(--msg-border); 
        text-align: center;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.05);
    }
    .exp-area{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-size:14px}
    #expBar{height:6px;width:100%;background:rgba(0,0,0,0.1);border-radius:3px;margin-top:4px}
    #expFill{height:100%;background:#ffaa7f;border-radius:3px;transition:width .5s ease}
    .exp-text{font-weight:bold;color:#f39c12}
    
    /* NEW CSS FOR DAILY QUEST */
    #questList p { margin: 6px 0; font-size: 15px; }
    
    /* NEW CSS FOR CALENDAR MOOD */
    #moodCalendar{width:100%; margin-top:12px; text-align:center}
    #calendarHeader{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px}
    #calendarGrid{display:grid; grid-template-columns:repeat(7, 1fr); gap:4px}
    .day-name{font-weight:bold; font-size:12px; padding:4px 0}
    .day-cell{
        width:100%; 
        aspect-ratio: 1 / 1; 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        border-radius:50%; 
        font-size:12px;
        font-weight:bold;
        background:var(--mood-default);
        color:var(--text);
        position:relative;
        transition:background .2s, color .2s;
    }
    .day-cell.mood-set {
        color: white; 
        cursor: help;
        box-shadow: 0 0 0 2px var(--card) inset; 
    }
    .day-cell.today{box-shadow: 0 0 0 3px var(--accent) !important; color:var(--accent)}

    /* NEW CSS FOR DAILY MESSAGE CARD */
    #dailyMessageCard {
        border: 2px solid var(--msg-border) !important;
        background: var(--msg-bg) !important;
        box-shadow: 0 6px 18px rgba(255, 133, 162, 0.2);
    }

    /* NEW CSS FOR SPARKLE EFFECT */
    .loveSparkle{position:absolute;font-size:16px;pointer-events:none;z-index:100;animation:fadeNscale 1.5s ease-out}
    @keyframes fadeNscale{0%{opacity:1;transform:scale(0.8)}100%{opacity:0;transform:scale(1.5)}}
    
    .loveHeart{position:fixed; font-size:28px; animation:floatUp 2.4s ease-out; pointer-events:none; z-index:9999}
    @keyframes floatUp{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-160px);opacity:0}}
    #secretModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(3px); align-items:center; justify-content:center; z-index:2000}
    #secretModal .box{background:var(--card); color:var(--text); padding:18px; border-radius:14px; width:88%; max-width:420px; text-align:center}
    
    /* üíñ FALLING HEARTS CSS üíñ */
    #fallContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
        z-index: 5; 
    }
    .fallingHeart {
        position: absolute;
        color: var(--msg-border); 
        font-size: 16px;
        opacity: 0.8;
        animation: heartFall 10s linear infinite;
    }
    @keyframes heartFall {
        0% { transform: translateY(-10vh) translateX(0) rotate(0); opacity: 0.8; }
        100% { transform: translateY(100vh) translateX(50px) rotate(360deg); opacity: 0.2; }
    }
    
    /* üç¥ NEW STICKER MODAL FOR EAT CHECK (V9.0) üç¥ */
    #stickerModal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 3000;
        animation: fadeInScale 0.3s ease-out;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        border-radius: 15px;
        background: var(--card); /* Background for the pop-up */
        padding: 10px;
    }

    #stickerModal img {
        display: block;
        width: 150px; /* Ukuran stiker */
        height: auto;
    }

    #stickerMessage {
        text-align: center;
        margin-top: 8px;
        font-weight: bold;
        color: var(--text);
        font-size: 1.1em;
        padding: 0 10px;
    }

    @keyframes fadeInScale {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    /* --- NEW CSS FOR PLANT FEATURE (V11.0) --- */
    .plant-card {
        border: 2px solid #5cb85c; /* Green border */
        background-color: #f7fff7; /* Light green background */
    }
    .dark .plant-card {
        border: 2px solid #4cae4c;
        background-color: #1e3a24;
    }
    #plantDisplay {
        font-size: 80px;
        min-height: 80px;
        margin: 10px 0;
        transition: transform 0.5s ease-out;
        display: inline-block;
    }
    #plantMessage {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--text);
        margin-bottom: 10px;
    }
    #plantProgress {
        background: #ccc;
        height: 8px;
        border-radius: 4px;
        margin-top: 5px;
    }
    #plantProgressFill {
        height: 100%;
        background: #5cb85c;
        border-radius: 4px;
        transition: width 0.5s ease-in-out;
    }


    @media (max-width:420px){ .mood{font-size:34px} } 
  </style>
</head>
<body>
  
  <div id="fallContainer"></div> 

  <div id="gate" style="position: fixed; inset: 0; background: var(--bg); color: var(--text); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
    <h1>üîí Hai, Mas! üíô</h1>
    <p style="margin: 0 0 16px 0;">Masukkan kode rahasia atau nama panggilan spesial dari caca untuk membuka.</p>
    <input type="text" id="gateInput" placeholder="Kode atau Nama Spesial" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 300px; margin-bottom: 12px; background: var(--card); color: var(--text);" />
    <button id="gateEnterBtn" class="btn" style="background: var(--accent); color: white;">Masuk ke Tracker</button>
    <p id="gateMsg" style="margin-top: 10px; color: #e74c3c; min-height: 20px;">
        Jika Mas baru saja mengganti kode, Mas mungkin perlu mengklik ‚ö†Ô∏è **Reset Semua Data** di dalam tracker agar misi harian Mas berjalan lancar!
    </p>
  </div>
  
  <h1>Mood Tracker Mas üíô</h1>

  <div class="controls">
    <button id="themeBtn" class="btn">üåô Mode</button>
    <button id="musicBtn" class="btn">‚ñ∂ Backsound</button>
    <button id="hugBtn" class="btn">ü´Ç Kirim Peluk</button>
    <button id="eatCheckBtn" class="btn" style="background: #e74c3c; color: white;">üç¥ Mas Sudah Makan?</button> 
    <button id="exportDataBtn" class="btn secondary">üìã Copy Data Mas</button> 
    <button id="resetDataBtn" class="btn secondary">‚ö†Ô∏è Reset Semua Data</button> 
    <button id="secretBtn" class="btn secondary">üíå Surat Rahasia</button>
    <button id="downloadBtn" class="btn secondary">‚¨áÔ∏è Download HTML</button>
    <button id="gdriveBtn" class="btn secondary">üñºÔ∏è Simpan Foto (Gdrive)</button> 
  </div>
  
  <p style="margin:6px 0 0 0">Klik mood mas hari ini ‚Äî langsung muncul reaksi manis dari caca:</p>

  <div class="mood-container">
    <span class="mood" data-mood="üòÑ Senang">üòÑ</span>
    <span class="mood" data-mood="üôÇ Biasa aja">üôÇ</span>
    <span class="mood" data-mood="üò¢ Sedih">üò¢</span>
    <span class="mood" data-mood="üò° Kesel">üò°</span>
    <span class="mood" data-mood="ü•∞ Sayang caca">ü•∞</span>
  </div>

  <div id="reaction"></div>
  
  <div id="stickerModal" style="display:none;">
    <img id="stickerImage" src="Belum makan.png" alt="Reaksi Caca">
    <p id="stickerMessage"></p>
  </div>
  <div class="card" id="dailyMessageCard">
    <h3 style="margin-top: 0; text-align: center;">üíå Pesan Harian dari Caca üíå</h3>
    <p id="dailyMessageContent" style="font-style: italic; text-align: center; margin: 0; font-size: 1.1em;">Belum ada pesan baru hari ini. ü•∫</p>
  </div>
  <div class="card" id="dailyQuestCard">
    <h3>‚ú® Misi Harian Buat Mas</h3>
    <div id="questList" style="list-style-type: none; padding: 0; margin: 0;">
      <em>Memuat misi harian...</em>
    </div>
  </div>
  
  <div class="card plant-card">
    <h3>üå± Pet Plant Caca & Mas</h3>
    <div id="plantDisplay"></div>
    <p id="plantMessage">Siram tanaman ini setiap hari agar ia bisa tumbuh menjadi pohon yang besar dan kuat! (Growth sangat lambat: 100 Hari untuk tahap 2)</p>
    <div style="font-size: 14px; margin-bottom: 5px;">Progress Tumbuh: <span id="currentWaterCount">0</span>/<span id="requiredWaterCount">0</span> Hari</div>
    <div id="plantProgress"><div id="plantProgressFill"></div></div>
    <button id="waterPlantBtn" class="btn" style="background: #5cb85c; margin-top: 15px;">üíß Siram Tanaman Hari Ini</button>
  </div>
  <div class="card">
    <h3>Catatan Mood & Statistik</h3>
    
    <p id="currentTitle"></p>
    
    <div class="exp-area">
        <span>Poin Cinta: <span id="currentEXP" class="exp-text">0</span></span>
        <span>Streak: <span id="currentStreak" class="exp-text">0</span> Hari</span>
    </div>
    <div id="expBar"><div id="expFill"></div></div>
    <small style="margin-top: 4px; display: block;">*Mendapatkan 10 Poin Cinta setiap hari!</small>
    
    <div id="statusMakan" style="margin-top: 15px; padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 8px;">
        üç¥ **Status Makan Hari Ini:** <span id="eatStatusText" style="font-weight: bold;">Belum dicek.</span>
    </div>

    <div id="moodCalendar">
      <div id="calendarHeader">
        <button id="prevMonth" class="btn secondary">&lt;</button>
        <h4 id="monthYear" style="margin:0;"></h4>
        <button id="nextMonth" class="btn secondary">&gt;</button>
      </div>
      <div id="calendarGrid">
        </div>
    </div>
    <div id="monthlySummary" style="margin-top: 15px; margin-bottom: 15px; padding: 10px; background: rgba(111, 168, 220, 0.1); border-radius: 8px;">
      <em>Loading ringkasan mood mas bulan ini...</em>
    </div>
    <canvas id="moodChart" height="140"></canvas>
    <div id="entries" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Catatan Penting dari Mas</h3>
    <textarea id="noteInput" placeholder="Mas mau nulis apa ke caca? (Bisa paste link Google Drive juga!)"></textarea>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button id="saveNote" class="btn">Simpan Catatan</button>
      <button id="clearNotes" class="btn secondary">Bersihkan Semua</button>
    </div>
    <div id="notes" style="margin-top:12px"></div>
  </div>

  <div class="card" style="cursor:pointer; text-align:center" id="secretPreview">
    <h3>üíô Buka Halaman Rahasia</h3>
    <small>Klik tombol Surat Rahasia atau tombol di atas</small>
  </div>

  <div id="secretModal">
    <div class="box">
      <h2>Pesan Rahasia Buat Mas üíå</h2>
      <p>Mas tuh rumah ternyaman caca... ü©µ<br>makasih udah ada di hidup caca yaaa...</p>
      
      <div style="margin-top:18px">
        <button id="closeSecret" class="btn">Tutup</button>
      </div>
    </div>
  </div>

  <audio id="bgm" loop preload="auto">
    <source src="music.mp3" type="audio/mpeg"> 
  </audio>

<script>
/* --- Utility & state --- */
// Gate Refs
const gate = document.getElementById('gate');
const gateInput = document.getElementById('gateInput');
const gateEnterBtn = document.getElementById('gateEnterBtn');

// Gate Code
const SECRET_CODE = "sayang"; 
const CODE_NAME = "Mas";    

// üíñ V7.0: Google Drive Link
const GDRIVE_URL = "https://drive.google.com/drive/folders/1pNab0FdgNSFbAy_xdocz19ZGrU3JC4sO?usp=sharing"; 

// üç¥ V9.0: Sticker Links
const KISS_STICKER_URL = "Sudah makan.png"; 
const LOOPY_STICKER_URL = "Belum makan.png"; 

// App Refs
const moodButtons = document.querySelectorAll('.mood');
const reaction = document.getElementById('reaction');
const entriesBox = document.getElementById('entries');
const notesBox = document.getElementById('notes');
const noteInput = document.getElementById('noteInput');
const bgm = document.getElementById('bgm');
const secretModal = document.getElementById('secretModal');
const FALL_CONTAINER = document.getElementById('fallContainer'); 
const stickerModal = document.getElementById('stickerModal'); 
const stickerImage = document.getElementById('stickerImage'); 
const stickerMessage = document.getElementById('stickerMessage'); 
let moodChart;
let isDark = false;
let currentCalendarDate = new Date(); 
let fallInterval; 

// Gamification State
let loveEXP = parseInt(localStorage.getItem('loveEXP') || '0');
let lastMoodDate = localStorage.getItem('lastMoodDate') || null;
let currentStreak = parseInt(localStorage.getItem('currentStreak') || '0');
let hugCount = parseInt(localStorage.getItem('hugCount') || '0'); 
const QUESTS_KEY = 'dailyQuests'; 
const DAILY_EXP_REWARD = 20;      
const DAILY_MSG_KEY = 'dailyMsgData'; 
const EAT_STATUS_KEY = 'eatStatus'; 

// üå≥ V11.0: Plant State
const PLANT_STAGE_KEY = 'masPlantStage';
const WATER_COUNT_KEY = 'masTotalWatered';
const LAST_WATERED_KEY = 'masLastWatered';
let plantStage = parseInt(localStorage.getItem(PLANT_STAGE_KEY) || '0'); 
let totalWateredCount = parseInt(localStorage.getItem(WATER_COUNT_KEY) || '0'); 
let lastWateredDatePlant = localStorage.getItem(LAST_WATERED_KEY) || null;
// Button ref will be defined in init when element is present
// const plantBtn = document.getElementById('waterPlantBtn');

// V11.2: MENAMBAHKAN QUEST SIRAM TANAMAN
const allQuests = [
    { text: "Kirim Pelukan Pertama Hari Ini", action: "hug" },
    { text: "Tulis Minimal 1 Catatan Penting", action: "note" },
    { text: "Catat Mood Lebih dari Sekali", action: "mood_2" },
    { text: "Buka Halaman Rahasia", action: "secret" },
    { text: "üíß Siram Tanaman Pet Plant", action: "water_plant" }, // NEW QUEST
    { text: "Kirim 2 Pelukan Hari Ini", action: "hug_2" },
    { text: "Tulis 2 Catatan Penting", action: "note_2"},
    { text: "Kirim 3 Pelukan Hari Ini", action: "hug_3" },
    { text: "Kirim 4 Pelukan Hari Ini", action: "hug_4" }
];

// KUMPULAN PESAN HARIAN DARI CACA (TIDAK BERUBAH)
const DAILY_MESSAGE_POOL = [
    "Mas adalah alasan caca tersenyum hari ini. Have a good day, sayang! üíô",
    "Mas tuh rumah ternyaman caca... makasih udah ada di hidup caca yaaa... ü•π",
    "Setiap caca lihat log mood Mas, caca tahu Mas sedang berjuang. Caca bangga sama Mas! üí™",
    "Caca selalu mendoakan yang terbaik untuk Mas. Jangan pernah menyerah, oke? üíñ",
    "Ingat, caca sayang Mas lebih dari yang Mas tahu! ü•∞",
    "Mood Mas adalah mood caca juga. Caca harap Mas bahagia hari ini! üòä",
    "Selamat pagi, sayang! Jangan lupa senyum paling manis Mas hari ini! üòò",
    "Semangat kerjanya Mas! Kalo capek, istirahat yaa. Caca tunggu kabar Mas! üòö",
    "Mas adalah hadiah terindah di hidup caca. Caca cinta Mas! ‚ú®",
    "Mas, caca selalu nemu tenangnya caca di diri mas ü§ç‚ú®",
    "Lucu ya mas‚Ä¶ dari semua orang, hati caca milih berhenti di mas üòåüíï",
    "Kalau ada yang paling bikin caca bersyukur hari ini, pasti mas üå∑",
    "Mas, caca nggak pernah minta apa-apa‚Ä¶ tapi semesta ngasih mas, dan caca jagain üíû",
    "Nggak ada yang ngalahin cara mas bikin caca nyaman ü§óüíó",
    "Cinta itu sederhana, mas‚Ä¶ kayak mas sama caca yang sama-sama mau stay üåôüíû",
    "Mas capek? sini‚Ä¶ caca peluk dulu ü§çü§≤üèª",
    "Mas itu alasan caca mau jadi lebih baik tiap hari ‚ú®",
];


/* --- Level System Data (TIDAK BERUBAH) --- */
const LOVE_LEVELS = [
    { exp: 0, title: "Sayang Junior üê£" },
    { exp: 100, title: "Jagoan Senyum Caca üòä" }, 
    { exp: 250, title: "Pahlawan Mood ü¶∏" },      
    { exp: 500, title: "Sayang Sejati üíç" },      
    { exp: 1000, title: "Pemilik Hati Caca üëë" }, 
    { exp: 1500, title: "Cinta Abadi ‚ú®" }       
];

/* --- Pet Plant Data (V11.1 - TIDAK BERUBAH) --- */
const PLANT_STAGES = [
    { emoji: 'üå∞', name: 'Biji Cinta', required_total: 0 }, 
    { emoji: 'üå±', name: 'Tunas Harapan', required_total: 100 }, 
    { emoji: 'ü™¥', name: 'Tanaman Muda', required_total: 250 },  
    { emoji: 'üå≥', name: 'Pohon Persahabatan', required_total: 500 }, 
    { emoji: 'üå≤', name: 'Pohon Keluarga', required_total: 1000 }, 
    { emoji: 'üëë', name: 'Pohon Mas & Caca', required_total: 1500 }  
];


/* --- Data helpers (TIDAK BERUBAH) --- */
function loadLogs(){ return JSON.parse(localStorage.getItem('masMoodLog')||'[]'); }
function saveLogs(logs){ localStorage.setItem('masMoodLog', JSON.stringify(logs)); }
function loadNotes(){ return JSON.parse(localStorage.getItem('masNotes')||'[]'); }
function saveNotes(n){ localStorage.setItem('masNotes', JSON.stringify(n)); }


/* --- Reactions map & Color Map (TIDAK BERUBAH) --- */
const reactions = {
  'üòÑ Senang':'mas seneng?? ya ampun caca ikut senenggg üò≠üíô peluk dulu sini ü´Ç',
  'üôÇ Biasa aja':'mas biasa aja ya hari ini? sini caca temenin biar makin happy üπß',
  'üò¢ Sedih':'kok mas sedihhhh üò≠üíô cini ciniiiiii, caca peyukkkkk ü´Çüπß',
  'üò° Kesel':'siapa yang bikin mas kesel?? ceritain yaaaa, biar caca cubit orang yang nakalin masssss üò§üíô',
  'ü•∞ Sayang caca':'aaaa mas sayang cacaaa?? caca juga sayang mas banyak banyakkkkkkk ü•πüπßüíô'
};

const MOOD_COLOR_MAP = {
    'üòÑ Senang': 'var(--mood-senang)',
    'üôÇ Biasa aja': 'var(--mood-biasa)',
    'üò¢ Sedih': 'var(--mood-sedih)',
    'üò° Kesel': 'var(--mood-kesel)',
    'ü•∞ Sayang caca': 'var(--mood-sayang)',
};


/* --- Gate Logic (TIDAK BERUBAH) --- */
function checkGate(code){
    const gateMsg = document.getElementById('gateMsg');
    if (code.toLowerCase() === SECRET_CODE || code === CODE_NAME) {
        gate.style.display = 'none';
        gateMsg.textContent = '';
        localStorage.setItem('gateOpened', 'true'); 
        initApp(); 
        return true;
    } else {
        gateMsg.textContent = 'Kode salah, Mas! Coba lagi ya.';
        return false;
    }
}

/* --- Gamification: EXP & Level Logic (TIDAK BERUBAH) --- */
function getLoveTitle(exp) {
    let currentTitle = LOVE_LEVELS[0].title;
    for (const level of LOVE_LEVELS) {
        if (exp >= level.exp) {
            currentTitle = level.title;
        } else {
            break; 
        }
    }
    return currentTitle;
}

function updateEXPDisplay() {
    const title = getLoveTitle(loveEXP);
    document.getElementById('currentTitle').textContent = `Gelar: ${title}`; 
    document.getElementById('currentEXP').textContent = loveEXP;
    document.getElementById('currentStreak').textContent = currentStreak;
    // Progress bar (per 100 EXP)
    const levelMax = 100;
    const progress = (loveEXP % levelMax) / levelMax;
    document.getElementById('expFill').style.width = `${progress * 100}%`;
}

/* --- Daily Message Logic (TIDAK BERUBAH) --- */
function loadDailyMessage() {
    if (DAILY_MESSAGE_POOL.length === 0) {
        return 'Belum ada pesan baru hari ini. ü•∫';
    }

    const storedData = JSON.parse(localStorage.getItem(DAILY_MSG_KEY));
    const today = new Date().toDateString();

    if (storedData && storedData.date === today) {
        return storedData.message; 
    }

    const randomIndex = Math.floor(Math.random() * DAILY_MESSAGE_POOL.length);
    const newMessage = DAILY_MESSAGE_POOL[randomIndex];

    localStorage.setItem(DAILY_MSG_KEY, JSON.stringify({
        date: today,
        message: newMessage
    }));
    
    return newMessage;
}

function renderDailyMessage() {
    const message = loadDailyMessage();
    const contentEl = document.getElementById('dailyMessageContent');
    contentEl.innerHTML = message.replace(/\n/g, '<br>');
}
/* --- END Daily Message Logic --- */

/* --- NEW FEATURE: EXPORT/COPY DATA (TIDAK BERUBAH) --- */
async function exportData() {
    // üå≥ V11.0: Add Plant Status to export
    const currentPlant = getPlantStageData();
    
    const data = {
        moodLog: loadLogs(),
        notes: loadNotes(),
        gamification: {
            loveEXP: loveEXP,
            currentStreak: currentStreak,
            hugCount: hugCount,
            title: getLoveTitle(loveEXP)
        },
        dailyMessage: loadDailyMessage(),
        eatStatus: loadEatStatus().status, 
        plantStatus: { 
            stage: currentPlant.name,
            totalWateredDays: totalWateredCount,
            lastWatered: lastWateredDatePlant
        },
        lastUpdated: new Date().toLocaleString('id-ID')
    };
    
    const json = JSON.stringify(data, null, 2); 
    
    try {
        await navigator.clipboard.writeText(json); 
        reaction.textContent = 'Data Mood Mas berhasil di-copy ke clipboard! Silakan tempel (paste) di chat ke caca! üìã';
    } catch (err) {
        reaction.textContent = 'Gagal copy otomatis. Mas harus kirim screenshot Log ini ya. ü•∫';
        console.error("Copy failed: ", err);
    }
}
/* --- END EXPORT/COPY DATA --- */


/* --- Hug Logic (TIDAK BERUBAH) --- */
function updateHugCount() {
    localStorage.setItem('hugCount', hugCount);
}

function sendHug() {
    const storedQuests = generateQuests(); 
    const isRewarded = storedQuests.rewarded;

    hugCount += 1;
    updateHugCount();
    
    // Tampilkan efek/pesan pelukan
    const h = document.createElement('div');
    h.className = 'loveHeart'; 
    h.style.fontSize = '40px';
    h.textContent = 'ü´Ç'; 
    h.style.left = '50%'; h.style.bottom = '-10px';
    h.style.transform = 'translateX(-50%)';
    document.body.appendChild(h); 
    setTimeout(() => h.remove(), 2500);

    // Notifikasi
    reaction.textContent = `Pelukan ke-${hugCount} berhasil dikirim ke caca! üíô`;
    
    // Check Quest Completion: panggil checker dengan actionType='hug'
    if (!isRewarded) {
        checkQuestCompletion('hug');
    }
}

/* --- Daily Quest Generator & Checker (MODIFIED V11.2) --- */
function generateQuests() {
    const today = new Date().toDateString();
    let storedQuests = JSON.parse(localStorage.getItem(QUESTS_KEY));

    if (!storedQuests || storedQuests.date !== today) {
        // Quest yang dijamin muncul: peluk, note, siram tanaman
        const guaranteedQuests = allQuests.filter(q => q.action === 'hug' || q.action === 'note' || q.action === 'water_plant');
        
        let pool = allQuests.filter(q => q.action !== 'hug' && q.action !== 'note' && q.action !== 'water_plant');
        let newQuests = [...guaranteedQuests];

        const numToPick = 3 - guaranteedQuests.length;
        if (numToPick > 0) {
            const shuffledPool = pool.sort(() => 0.5 - Math.random());
            newQuests = newQuests.concat(shuffledPool.slice(0, numToPick));
        }

        storedQuests = { date: today, list: newQuests.map(q => ({ ...q, completed: false })), rewarded: false };
        localStorage.setItem(QUESTS_KEY, JSON.stringify(storedQuests));
    }
    return storedQuests;
}


function renderQuests() {
    const storedQuests = generateQuests();
    const quests = storedQuests.list;
    const listEl = document.getElementById('questList');
    listEl.innerHTML = '';
    
    if (storedQuests.rewarded) {
        listEl.innerHTML = '<p style="font-weight: bold; color: var(--accent);">üéâ Semua Misi Hari Ini Selesai! Mas sudah dapat hadiah EXP! üéâ</p>';
        return;
    }

    if(quests.length === 0) {
        listEl.innerHTML = '<em>Tidak ada misi hari ini.</em>';
        return;
    }

    quests.forEach((q, index) => {
        const item = document.createElement('p');
        const status = q.completed ? '‚úÖ' : '‚¨ú';
        item.innerHTML = `${status} ${q.text}`;
        item.style.margin = '4px 0';
        
        if (q.completed) {
            item.style.opacity = '0.6';
            item.style.textDecoration = 'line-through'; 
        } else {
            item.style.opacity = '1';
            item.style.textDecoration = 'none';
        }
        
        listEl.appendChild(item);
    });
}

function checkQuestCompletion(actionType, value = null) {
    let storedQuests = generateQuests();
    let changed = false;

    if (storedQuests.rewarded) return; 

    // Mendapatkan jumlah log dan catatan hari ini
    const logs = loadLogs();
    const notes = loadNotes();
    const today = new Date().toDateString();
    const todayLogsCount = logs.filter(l => new Date(l.date).toDateString() === today).length;
    const todayNotesCount = notes.filter(n => new Date(n.time).toDateString() === today).length;
    const isWateredToday = lastWateredDatePlant === today; // V11.2: Check plant status

    storedQuests.list.forEach(q => {
        if (q.completed) return;

        let conditionMet = false;

        // --- Core Logic: Check conditions based on quest action ---

        if (q.action === 'secret' && actionType === 'secret') {
            conditionMet = true;
        }

        if (q.action === 'mood_2' && actionType.startsWith('mood')) {
            if (todayLogsCount >= 2) {
                conditionMet = true;
            }
        }
        
        // V11.2: Check for water_plant action
        if (q.action === 'water_plant' && actionType === 'water_plant') {
            // Kita cek lagi di sini, karena waterPlant() baru saja di panggil
            if (isWateredToday) { 
                 conditionMet = true;
            }
        }

        if (actionType === 'hug' || q.action.startsWith('hug')) { 
            if (q.action === 'hug' && hugCount >= 1) {
                conditionMet = true;
            }
            const hugMatch = q.action.match(/^hug_(\d+)$/);
            if (hugMatch) {
                const requiredHugs = parseInt(hugMatch[1]);
                if (hugCount >= requiredHugs) {
                    conditionMet = true;
                }
            }
        }
        
        if (actionType === 'note' || q.action.startsWith('note')) {
            if (q.action === 'note' && todayNotesCount >= 1) {
                conditionMet = true;
            }
            const noteMatch = q.action.match(/^note_(\d+)$/);
            if (noteMatch) {
                const requiredNotes = parseInt(noteMatch[1]);
                if (todayNotesCount >= requiredNotes) {
                    conditionMet = true;
                }
            }
        }
        
        if (conditionMet) {
            q.completed = true;
            changed = true;
        }
    });
    // --- End Core Logic ---

    if (changed) {
        localStorage.setItem(QUESTS_KEY, JSON.stringify(storedQuests));
        
        const allCompleted = storedQuests.list.every(q => q.completed);
        if (allCompleted) {
            loveEXP += DAILY_EXP_REWARD;
            localStorage.setItem('loveEXP', loveEXP);
            storedQuests.rewarded = true; 
            localStorage.setItem(QUESTS_KEY, JSON.stringify(storedQuests));

            updateEXPDisplay();
            renderQuests(); 
            reaction.textContent = `SEMUA MISI HARIAN SELESAI! üéâ Mas dapat ${DAILY_EXP_REWARD} Poin Cinta Tambahan!`;
        } else {
            renderQuests(); 
        }
    }
}
/* --- END Daily Quest Logic --- */

/* --- MOOD CALENDAR LOGIC (TIDAK BERUBAH) --- */
function getMoodsByDate() {
    const logs = loadLogs();
    const moods = {};
    logs.forEach(l => {
        const dateKey = new Date(l.date).toDateString();
        if (!moods[dateKey]) {
            moods[dateKey] = l.mood;
        }
    });
    return moods;
}

function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();
    const todayDateString = new Date().toDateString();
    const moods = getMoodsByDate();
    
    document.getElementById('monthYear').textContent = date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    const daysOfWeek = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
    daysOfWeek.forEach(day => {
        const d = document.createElement('div');
        d.className = 'day-name';
        d.textContent = day;
        grid.appendChild(d);
    });

    const firstDayOfMonth = new Date(year, month, 1).getDay(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDayOfMonth; i++) {
        grid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = new Date(year, month, day).toDateString();
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.textContent = day;

        const mood = moods[dateKey];
        if (mood) {
            const moodColor = MOOD_COLOR_MAP[mood] || 'var(--mood-default)';
            cell.style.backgroundColor = moodColor;
            cell.classList.add('mood-set');
            const logEntry = loadLogs().find(l => new Date(l.date).toDateString() === dateKey);
            let titleText = `Mood: ${mood}`;
            if (logEntry && logEntry.reason) {
                 titleText += `\nAlasan: ${logEntry.reason}`;
            }
            cell.title = titleText;
        }

        if (dateKey === todayDateString) {
            cell.classList.add('today');
        }

        grid.appendChild(cell);
    }
}

function updateCalendarMonth(change) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + change);
    renderCalendar(currentCalendarDate);
}
/* --- END MOOD CALENDAR LOGIC --- */

/* --- EAT CHECK LOGIC (TIDAK BERUBAH) --- */
function loadEatStatus() {
    const today = new Date().toDateString();
    let storedStatus = JSON.parse(localStorage.getItem(EAT_STATUS_KEY) || '{"date": "", "status": "Belum Dicek"}');

    // Jika hari sudah berganti, reset status
    if (storedStatus.date !== today) {
        storedStatus = { date: today, status: "Belum Dicek" };
        localStorage.setItem(EAT_STATUS_KEY, JSON.stringify(storedStatus));
    }
    return storedStatus;
}

function renderEatStatus() {
    const statusData = loadEatStatus();
    const statusEl = document.getElementById('eatStatusText');
    const cardEl = document.getElementById('statusMakan');

    if (!statusEl || !cardEl) return; // Safely exit if elements not found

    statusEl.textContent = statusData.status;

    if (statusData.status === "Sudah Makan ‚úÖ") {
        cardEl.style.backgroundColor = 'rgba(76, 175, 80, 0.1)'; // Green
        cardEl.style.border = '1px solid #4CAF50';
    } else if (statusData.status === "Belum Makan ‚ùå") {
        cardEl.style.backgroundColor = 'rgba(244, 67, 54, 0.1)'; // Red
        cardEl.style.border = '1px solid #F44336';
    } else {
        cardEl.style.backgroundColor = 'rgba(255, 193, 7, 0.1)'; // Yellow/Default
        cardEl.style.border = '1px solid #FFC107';
    }
}

function showSticker(isEaten) {
    if (!stickerModal) return;

    // Mas's uploaded stickers are used here:
    if (isEaten) {
        stickerImage.src = KISS_STICKER_URL; 
        stickerMessage.textContent = "Good job, Mas! Sini caca cium üòö";
    } else {
        stickerImage.src = LOOPY_STICKER_URL;
        stickerMessage.textContent = "MAS! JANGAN LUPA MAKAN SEKARANG! üò†";
    }
    
    stickerModal.style.display = 'block';

    // Hilangkan stiker setelah 3.5 detik
    setTimeout(() => {
        stickerModal.style.display = 'none';
    }, 3500);
}

const eatCheckBtn = document.getElementById('eatCheckBtn');
if (eatCheckBtn) {
    eatCheckBtn.addEventListener('click', () => {
        const statusData = loadEatStatus();

        // Jika sudah dicek hari ini, berikan pesan khusus
        if (statusData.status !== "Belum Dicek") {
            reaction.textContent = `Status makan Mas hari ini sudah tercatat sebagai: ${statusData.status}. Mau ganti status? Jawab di prompt. üòä`;
        }

        const answer = prompt('Mas udah makan hari ini? Ketik "Udah" atau "Belum" (Huruf besar/kecil tidak masalah)');

        if (answer === null) return; // User cancelled

        const input = answer.trim().toLowerCase();
        let newStatus = statusData.status;

        if (input === "udah" || input === "sudah") {
            newStatus = "Sudah Makan ‚úÖ";
            showSticker(true);
        } else if (input === "belum") {
            newStatus = "Belum Makan ‚ùå";
            showSticker(false);
        } else {
            reaction.textContent = "Jawaban tidak valid. Coba lagi dengan 'Udah' atau 'Belum' ya, Mas. üòä";
            return;
        }

        // Update status dan simpan
        if (newStatus !== statusData.status) {
            const today = new Date().toDateString();
            localStorage.setItem(EAT_STATUS_KEY, JSON.stringify({ date: today, status: newStatus }));
            renderEatStatus();
            reaction.textContent = newStatus === "Sudah Makan ‚úÖ" ? "Yay! Mas sudah makan. Caca lega! üíñ" : "Cepat cari makan ya, Mas! Caca tunggu kabar Mas sudah makan! ü•∫";
        } else {
            reaction.textContent = `Status makan Mas hari ini sudah tercatat sebagai: ${newStatus}`;
        }
    });
}
/* --- END EAT CHECK LOGIC --- */

/* --- PET PLANT LOGIC (MODIFIED V11.2) --- */
function getPlantStageData() {
    let currentStage = 0;
    for (let i = 0; i < PLANT_STAGES.length; i++) {
        if (totalWateredCount >= PLANT_STAGES[i].required_total) {
            currentStage = i;
        } else {
            break;
        }
    }
    // Update the saved stage if it's different
    if (plantStage !== currentStage) {
        plantStage = currentStage;
        localStorage.setItem(PLANT_STAGE_KEY, plantStage);
    }
    return PLANT_STAGES[plantStage];
}


function renderPlant() {
    const today = new Date().toDateString();
    const currentPlant = getPlantStageData();
    const isWateredToday = lastWateredDatePlant === today;
    const nextStage = PLANT_STAGES[plantStage + 1];
    
    document.getElementById('plantDisplay').textContent = currentPlant.emoji;
    document.getElementById('plantDisplay').title = currentPlant.name;
    document.getElementById('plantMessage').textContent = `Status: ${currentPlant.name}`;

    const plantBtn = document.getElementById('waterPlantBtn');
    if (plantBtn) {
        plantBtn.disabled = isWateredToday || plantStage === PLANT_STAGES.length - 1;
        plantBtn.textContent = isWateredToday ? '‚úÖ Sudah Disiram Hari Ini' : 'üíß Siram Tanaman Hari Ini';
        if (plantStage === PLANT_STAGES.length - 1) {
            plantBtn.textContent = 'ü•≥ Sudah Tumbuh Sempurna!';
        }
    }
    
    // Progress bar logic
    const currentWaterCountEl = document.getElementById('currentWaterCount');
    const requiredWaterCountEl = document.getElementById('requiredWaterCount');
    const plantProgressFillEl = document.getElementById('plantProgressFill');
    
    if (!currentWaterCountEl || !requiredWaterCountEl || !plantProgressFillEl) return;

    if (plantStage === PLANT_STAGES.length - 1) {
        // Max level
        currentWaterCountEl.textContent = totalWateredCount;
        requiredWaterCountEl.textContent = totalWateredCount; 
        plantProgressFillEl.style.width = `100%`;
    } else if (nextStage) {
        const prevRequired = currentPlant.required_total;
        const requiredForNext = nextStage.required_total;
        
        const progressRange = requiredForNext - prevRequired;
        const progressValue = totalWateredCount - prevRequired;
        const progressPercent = (progressValue / progressRange) * 100;
        
        currentWaterCountEl.textContent = progressValue;
        requiredWaterCountEl.textContent = progressRange;
        plantProgressFillEl.style.width = `${progressPercent}%`;
    }
}


function waterPlant() {
    const today = new Date().toDateString();

    if (lastWateredDatePlant === today) {
        reaction.textContent = "Mas, tanaman sudah disiram hari ini. Tunggu besok ya! üíß";
        return;
    }
    
    if (plantStage === PLANT_STAGES.length - 1) {
        reaction.textContent = "Hore! Tanaman Mas sudah tumbuh sempurna. Dia bahagia dengan cinta Mas! üëë";
        const plantBtn = document.getElementById('waterPlantBtn');
        if (plantBtn) plantBtn.disabled = true;
        return;
    }

    // Update state
    totalWateredCount += 1;
    lastWateredDatePlant = today;
    
    localStorage.setItem(WATER_COUNT_KEY, totalWateredCount);
    localStorage.setItem(LAST_WATERED_KEY, lastWateredDatePlant);

    // Check for growth
    const oldStage = plantStage;
    getPlantStageData(); 

    if (plantStage > oldStage) {
        reaction.textContent = `HORE! Tanaman Mas naik level menjadi ${PLANT_STAGES[plantStage].name}! üåü`;
        // Add a small shake animation for the plant
        const plantDisplay = document.getElementById('plantDisplay');
        plantDisplay.style.transform = 'scale(1.2) rotate(5deg)';
        setTimeout(() => plantDisplay.style.transform = 'scale(1) rotate(0deg)', 500);
    } else {
        reaction.textContent = "Terima kasih, Mas! Tanaman sudah disiram. Dia semakin kuat! üí™";
    }

    renderPlant();
    // V11.2: Check quest completion right after successful watering
    checkQuestCompletion('water_plant');
}

// Event Listener for Plant (added in initApp to ensure element exists)

/* --- END PET PLANT LOGIC --- */


// üíñ New core function to handle EXP/Logging (TIDAK BERUBAH)
function handleMoodEntry(mood, reason) {
    const today = new Date().toDateString();
    let expGained = false;

    // Logic EXP & STREAK
    if (lastMoodDate !== today) {
        const oldTitle = getLoveTitle(loveEXP); 
        loveEXP += 10; 
        if (lastMoodDate) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastMoodDate === yesterday.toDateString()) {
                currentStreak += 1;
            } else {
                currentStreak = 1; 
            }
        } else {
            currentStreak = 1; 
        }
        localStorage.setItem('loveEXP', loveEXP);
        localStorage.setItem('lastMoodDate', today);
        localStorage.setItem('currentStreak', currentStreak);
        updateEXPDisplay();
        expGained = true;
        
        const newTitle = getLoveTitle(loveEXP);
        if (newTitle !== oldTitle) {
            reaction.textContent = `LEVEL UP! Mas naik ke Gelar: ${newTitle}! üèÜ`;
            return; 
        }
    }

    const date = new Date().toLocaleString('id-ID');
    // Entry now includes reason
    const entry = { mood, date, reason: reason || 'Tidak ada alasan spesifik.' }; 
    const logs = loadLogs();
    
    const cleanedLogs = logs.filter(l => new Date(l.date).toDateString() !== today);
    
    cleanedLogs.unshift(entry);
    saveLogs(cleanedLogs);
    renderLogs();
    
    checkQuestCompletion('mood_2');

    let reactionText = reactions[mood] || '';
    if (expGained) {
        reactionText += ` (+10 Poin Cinta! üíñ)`;
    }
    reaction.textContent = reactionText;

    spawnTinyHearts();
    if(mood.includes('Sayang')) spawnBigHearts();
    updateChart();
    renderMonthlySummary(); 
    renderCalendar(currentCalendarDate);
}


/* --- Mood click handler (TIDAK BERUBAH) --- */
moodButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const mood = btn.dataset.mood;
    // Prompt for reason (Mood Reason Box)
    const reason = prompt(`Tulis alasan Mas memilih mood "${mood}" hari ini (Opsional):`);
    
    if (reason === null) {
        reaction.textContent = "Pencatatan mood dibatalkan. Mas butuh waktu sendiri? Caca siap menunggu. üíô";
        return;
    }

    handleMoodEntry(mood, reason.trim());
  });
});

/* --- Delete Log handler (TIDAK BERUBAH) --- */
window.deleteLog = function(index){
  const logs = loadLogs();
  if(confirm(`Yakin ingin menghapus log mood: ${logs[index].mood} pada ${logs[index].date}?`)){
    logs.splice(index, 1);
    saveLogs(logs);
    renderLogs();
    updateChart();
    renderMonthlySummary();
    renderCalendar(currentCalendarDate);
    checkQuestCompletion('mood_2'); 
  }
}

/* --- Delete Note handler (TIDAK BERUBAH) --- */
window.deleteNote = function(index){
  const notes = loadNotes();
  if(confirm(`Yakin ingin menghapus catatan ini?`)){
    notes.splice(index, 1);
    saveNotes(notes);
    renderNotes();
    checkQuestCompletion('note'); 
  }
}


/* --- Render logs & notes (TIDAK BERUBAH) --- */
function renderLogs(){
  const logs = loadLogs();
  entriesBox.innerHTML = '';
  if(logs.length===0) entriesBox.innerHTML = '<em>Belum ada mood tercatat.</em>';
  
  logs.forEach((l, index)=>{ 
    const d = document.createElement('div');
    let reasonHtml = '';
    // V11.0: Check for reason and display it
    if (l.reason && l.reason !== 'Tidak ada alasan spesifik.') {
        reasonHtml = `<div style="font-size: 13px; color: var(--text); margin-top: 4px; padding-left: 10px; border-left: 3px solid var(--accent); opacity: 0.8; line-height: 1.4;">
            <span style="font-weight: bold;">Alasan:</span> ${l.reason}
        </div>`;
    }

    d.innerHTML = `
      <div class="log-header">
        <span>${l.date} ‚Äî ${l.mood}</span>
        <span class="delete-btn" onclick="deleteLog(${index})">üóëÔ∏è Hapus</span>
      </div>
      ${reasonHtml}
    `;
    
    entriesBox.appendChild(d);
  });
}

function renderNotes(){
  const notes = loadNotes();
  notesBox.innerHTML = '';
  if(notes.length===0) notesBox.innerHTML = '<em>Belum ada catatan.</em>';
  
  notes.forEach((n, index)=>{
    const d = document.createElement('div');
    
    const content = document.createElement('span');
    content.style.flexGrow = 1;
    content.style.wordBreak = 'break-word';

    const urlRegex = /(https?:\/\/[^\s]+)/g; 
    const text = n.text.replace(/\n/g, '<br>'); 
    
    const textWithLinks = text.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" style="color: var(--accent); font-weight: bold; text-decoration: underline;">[LINK FOTO/GDRIVE]</a>`;
    });
    
    content.innerHTML = `<span style="font-size: 14px; color: gray; display:block; margin-bottom: 4px;">${n.time}</span>${textWithLinks}`;
    
    const deleteBtn = document.createElement('span');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = 'üóëÔ∏è Hapus';
    deleteBtn.onclick = () => deleteNote(index); // V11.0: Using the new deleteNote function
    deleteBtn.style.flexShrink = 0; 

    d.appendChild(content);
    d.appendChild(deleteBtn);
    notesBox.appendChild(d);
  });
}


/* --- Visual Effect & Animations (TIDAK BERUBAH) --- */
function startSparkles(el) {
    el.addEventListener('mousemove', function(e) {
        if (Math.random() < 0.2) { 
            const sparkle = document.createElement('div');
            sparkle.className = 'loveSparkle';
            sparkle.textContent = '‚ú®'; 
            const rect = el.getBoundingClientRect();
            sparkle.style.left = (e.clientX - rect.left) + 'px';
            sparkle.style.top = (e.clientY - rect.top) + 'px';
            sparkle.style.position = 'absolute';

            el.appendChild(sparkle);
            setTimeout(() => sparkle.remove(), 1500);
        }
    });
}

function spawnTinyHearts(){
  for(let i=0;i<6;i++){
    const h = document.createElement('div'); h.className='loveHeart'; h.textContent='üíô';
    h.style.left = Math.random()*92 + 'vw'; h.style.bottom = '-10px';
    document.body.appendChild(h); setTimeout(()=>h.remove(), 2500);
  }
}
function spawnBigHearts(){
  for(let i=0;i<12;i++){
    const h = document.createElement('div'); h.className='loveHeart';
    h.style.fontSize = 34 + Math.floor(Math.random()*18) + 'px'; h.textContent = 'üíñ';
    h.style.left = (40 + Math.random()*20) + 'vw'; h.style.bottom = '-10px';
    document.body.appendChild(h); setTimeout(()=>h.remove(), 2600);
  }
}

function startFallingHearts() {
    if (fallInterval) clearInterval(fallInterval);
    if (!FALL_CONTAINER) return;

    fallInterval = setInterval(() => {
        const h = document.createElement('div');
        h.className = 'fallingHeart';
        h.textContent = 'üíñ'; 
        
        h.style.left = Math.random() * 100 + 'vw';
        h.style.animationDuration = (8 + Math.random() * 5) + 's';
        h.style.animationDelay = (Math.random() * 2) + 's';
        h.style.fontSize = (12 + Math.random() * 10) + 'px';

        FALL_CONTAINER.appendChild(h);

        setTimeout(() => h.remove(), 15000); 
    }, 500); 
}


/* --- Chart Update (TIDAK BERUBAH) --- */
function updateChart(){
  const logs = loadLogs();
  const moodNames = ['üòÑ Senang','üôÇ Biasa aja','üò¢ Sedih','üò° Kesel','ü•∞ Sayang caca'];
  const counts = moodNames.map(m => logs.filter(l => l.mood===m).length);
  const ctx = document.getElementById('moodChart').getContext('2d');
  if(moodChart) moodChart.destroy();
  moodChart = new Chart(ctx, {
    type:'bar',
    data: { labels: moodNames, datasets: [{ label:'Jumlah', data: counts, backgroundColor: ['#66c2ff','#99d6ff','#aab6ff','#c0c0ff','#ffb6c1'] }] },
    options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{precision:0} } } }
  });
}

/* --- Monthly Summary (TIDAK BERUBAH) --- */
function renderMonthlySummary(){
  const logs = loadLogs();
  const summaryBox = document.getElementById('monthlySummary');
  
  if (logs.length === 0) {
    summaryBox.innerHTML = '<em>Catatan mood masih kosong. Yuk, mulai hari ini!</em>';
    return;
  }
  
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  const currentMonthLogs = logs.filter(l => {
    const logDate = new Date(l.date);
    return logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear;
  });
  
  if (currentMonthLogs.length === 0) {
    summaryBox.innerHTML = '<em>Belum ada catatan mood di bulan ini.</em>';
    return;
  }
  
  const moodCounts = {};
  currentMonthLogs.forEach(l => {
    const moodKey = l.mood.split(' ')[0]; 
    moodCounts[moodKey] = (moodCounts[moodKey] || 0) + 1;
  });
  
  let dominantMoodText = '';
  let maxCount = 0;
  let totalCount = currentMonthLogs.length;

  for (const moodKey in moodCounts) {
    if (moodCounts[moodKey] > maxCount) {
      maxCount = moodCounts[moodKey];
      for (const fullMood in reactions) {
        if (fullMood.startsWith(moodKey)) {
          dominantMoodText = fullMood;
          break;
        }
      }
    }
  }

  const percentage = ((maxCount / totalCount) * 100).toFixed(0);

  let message = `Mood Mas di bulan ini (${now.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}) didominasi oleh **${dominantMoodText}** (${percentage}% dari total ${totalCount} catatan). `;
  
  if (dominantMoodText.includes('Senang') || dominantMoodText.includes('Sayang')) {
    message += `Pertahankan mood baik ini, mas sayang! caca ikut bahagia! ü•≥üíô`;
  } else if (dominantMoodText.includes('Sedih') || dominantMoodText.includes('Kesel')) {
    message += `Yuk, coba lebih banyak tersenyum! caca selalu di sini untuk menemani Mas. ü§ó`;
  } else {
    message += `Semoga hari-hari berikutnya makin berwarna dan happy ya, Mas!`;
  }
  
  summaryBox.innerHTML = `<p style="font-weight: bold; margin: 0">${message}</p>`;
}


/* --- Event Listeners lainnya (MODIFIED V11.2 - Reset Data) --- */

// Save Note Listener (TIDAK BERUBAH)
document.getElementById('saveNote').addEventListener('click', ()=>{
  const text = noteInput.value.trim();
  if(!text) return;
  const notes = loadNotes();
  notes.unshift({ text, time: new Date().toLocaleString('id-ID') });
  saveNotes(notes);
  noteInput.value='';
  renderNotes();
  checkQuestCompletion('note');
});

// Export/Copy Data Listener (TIDAK BERUBAH)
document.getElementById('exportDataBtn').addEventListener('click', exportData);

// GDrive Button Listener (TIDAK BERUBAH)
document.getElementById('gdriveBtn').addEventListener('click', ()=>{
  window.open(GDRIVE_URL, '_blank');
  reaction.textContent = "Membuka Google Drive Mas! Jangan lupa simpan foto manis Mas di sana. üñºÔ∏è";
});


document.getElementById('clearNotes').addEventListener('click', ()=>{
  if(confirm('Bersihkan semua catatan?')){ 
    localStorage.removeItem('masNotes'); 
    renderNotes(); 
    checkQuestCompletion('note'); 
  }
});
noteInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ document.getElementById('saveNote').click(); e.preventDefault(); }});

// Secret Button Listener (TIDAK BERUBAH)
document.getElementById('secretBtn').addEventListener('click', ()=>{ 
    secretModal.style.display='flex'; 
    checkQuestCompletion('secret');
    renderDailyMessage(); 
});
document.getElementById('closeSecret').addEventListener('click', ()=>{ secretModal.style.display='none'; });
document.getElementById('secretPreview').addEventListener('click', ()=>{ 
    secretModal.style.display='flex'; 
    checkQuestCompletion('secret');
    renderDailyMessage(); 
});

// HUG BUTTON LISTENER (TIDAK BERUBAH)
document.getElementById('hugBtn').addEventListener('click', sendHug); 

// Calendar Controls Listener (TIDAK BERUBAH)
document.getElementById('prevMonth').addEventListener('click', () => updateCalendarMonth(-1));
document.getElementById('nextMonth').addEventListener('click', () => updateCalendarMonth(1));

// Plant Button Listener (TIDAK BERUBAH)
const plantBtn = document.getElementById('waterPlantBtn');
if (plantBtn) {
    plantBtn.addEventListener('click', waterPlant);
}


document.getElementById('musicBtn').addEventListener('click', ()=>{
  if(bgm.paused){ bgm.play(); document.getElementById('musicBtn').textContent='‚è∏ Backsound'; }
  else { bgm.pause(); document.getElementById('musicBtn').textContent='‚ñ∂ Backsound'; }
});
bgm.addEventListener('play', ()=>{ document.getElementById('musicBtn').textContent='‚è∏ Backsound'; });
bgm.addEventListener('pause', ()=>{ document.getElementById('musicBtn').textContent='‚ñ∂ Backsound'; });

document.getElementById('themeBtn').addEventListener('click', ()=>{
  document.body.classList.toggle('dark'); isDark = document.body.classList.contains('dark');
  document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è Mode' : 'üåô Mode';
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'mood_tracker_mas.html';
  document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});

/* --- FINAL FIX: Reset Data Handler (MODIFIED V11.2 - Menambah water_plant reset) --- */
document.getElementById('resetDataBtn').addEventListener('click', ()=>{
  if(confirm('Yakin ingin menghapus SEMUA data mood, catatan, EXP, Level, Streak, Status Makan, dan Tanaman? Ini tidak bisa dikembalikan!')){
    // Data Aplikasi Utama
    localStorage.removeItem('masMoodLog');
    localStorage.removeItem('masNotes');
    localStorage.removeItem('gateOpened'); 

    // KUNCI: DATA GAMIFIKASI, QUEST, & MESSAGE
    localStorage.removeItem('loveEXP');
    localStorage.removeItem('lastMoodDate');
    localStorage.removeItem('currentStreak');
    localStorage.removeItem(QUESTS_KEY); 
    localStorage.removeItem('hugCount'); 
    localStorage.removeItem(DAILY_MSG_KEY); 
    localStorage.removeItem(EAT_STATUS_KEY); 
    
    // üå≥ V11.1/V11.2: Hapus data Tanaman
    localStorage.removeItem(PLANT_STAGE_KEY); 
    localStorage.removeItem(WATER_COUNT_KEY); 
    localStorage.removeItem(LAST_WATERED_KEY); 

    // Now, force reload to apply clean state
    alert('Data berhasil di-reset! Silakan muat ulang halaman.');
    window.location.reload();
  }
});


/* --- Fungsi Utama Aplikasi --- */
function initApp() {
    renderLogs(); 
    renderNotes(); 
    updateChart(); 
    renderMonthlySummary();
    updateEXPDisplay(); 
    renderQuests(); 
    updateHugCount(); 
    renderCalendar(currentCalendarDate); 
    renderDailyMessage(); 
    renderEatStatus(); 
    renderPlant(); // üå≥ V11.1: Render plant
    
    // Terapkan efek sparkle dan hujan hati
    startSparkles(document.querySelector('.mood-container'));
    startSparkles(document.getElementById('secretPreview'));
    startFallingHearts(); 
}


/* --- Init: Pengecekan Gate --- */
gateEnterBtn.addEventListener('click', () => {
    checkGate(gateInput.value.trim());
});

gateInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        checkGate(gateInput.value.trim());
    }
});

// Jalankan initApp segera jika gate sudah pernah dibuka
if (localStorage.getItem('gateOpened') === 'true') {
    gate.style.display = 'none';
    initApp();
}
</script>

</body>
</html>
